# GitHub Actions 工作流：Flutter 静态代码分析
#
# 这个工作流会在每次有代码推送到 main 分支或创建/更新 main 分支的 Pull Request 时被触发。
# 它的主要任务是运行 `flutter analyze` 来检查代码中是否存在潜在错误、警告或风格问题。

name: Flutter Analyzer

# 触发工作流的事件
on:
  # 1. 推送到 main 分支时触发
  push:
    branches: [ main ]
  # 2. 对 main 分支发起 Pull Request 时触发
  pull_request:
    branches: [ main ]

jobs:
  # 定义一个名为 "analyze" 的任务
  analyze:
    # 指定任务运行的虚拟环境
    runs-on: ubuntu-latest

    # 任务执行的步骤
    steps:
      # 步骤 1: 检出代码
      # 使用 GitHub 官方的 `checkout` action 来获取你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: 设置 Flutter 环境
      # 使用 `subosito/flutter-action` 这个广受欢迎的 action 来安装和配置 Flutter SDK
      # 它可以缓存 SDK，后续运行会更快
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          # 切换到 master 频道以获取最新的 Dart SDK
          channel: 'master'
          cache: true

      # 步骤 3 & 4: 安装依赖并运行分析
      # 将 `pub get` 和 `analyze` 合并为一步。这样无论哪一个失败，
      # 都会被 `continue-on-error` 捕获，并允许后续步骤运行。
      # 完整的输出（包括 `pub get` 的错误）都会被记录到日志文件中。
      - name: Install Dependencies and Run Analysis
        id: analysis_step
        run: |
          {
            echo "--- Installing Dependencies (flutter pub get) ---"
            flutter pub get
            echo "--- Running Static Analysis (flutter analyze) ---"
            flutter analyze
          } > flutter_analyze.log 2>&1
        continue-on-error: true

      # 步骤 5: 如果分析失败，则在 PR 中添加评论
      # 仅当上面的组合步骤失败时运行
      - name: Comment on PR on failure
        if: steps.analysis_step.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PR_COMMENTER_TOKEN }}
          script: |
            const fs = require('fs');

            if (context.eventName === 'pull_request') {
              const prNumber = context.issue.number;
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

              let errorOutput = '无法读取错误日志。';
              try {
                // 读取组合步骤产生的日志文件
                errorOutput = fs.readFileSync('flutter_analyze.log', 'utf8');
              } catch (e) {
                console.error('Error reading log file:', e);
              }

              const body = `
              ❌ **CI Check 失败**

              工作流在执行过程中遇到错误。

              *   **[查看完整的CI日志](${runUrl})**

              <details>
              <summary>点击展开错误详情</summary>

              \`\`\`
              ${errorOutput}
              \`\`\`
              </details>
              `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
