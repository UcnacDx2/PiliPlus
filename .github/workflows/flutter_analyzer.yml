# GitHub Actions 工作流：Flutter 静态代码分析
#
# 这个工作流会在每次有代码推送到 main 分支或创建/更新 main 分支的 Pull Request 时被触发。
# 它的主要任务是运行 `flutter analyze` 来检查代码中是否存在潜在错误、警告或风格问题。

name: Flutter Analyzer

# 触发工作流的事件
on:
  # 1. 推送到 main 分支时触发
  push:
    branches: [ main ]
  # 2. 对 main 分支发起 Pull Request 时触发
  pull_request:
    branches: [ main ]

jobs:
  # 定义一个名为 "analyze" 的任务
  analyze:
    # 指定任务运行的虚拟环境
    runs-on: ubuntu-latest

    # 任务执行的步骤
    steps:
      # 步骤 1: 检出代码
      # 使用 GitHub 官方的 `checkout` action 来获取你的仓库代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤 2: 设置 Flutter 环境
      # 使用 `subosito/flutter-action` 这个广受欢迎的 action 来安装和配置 Flutter SDK
      # 它可以缓存 SDK，后续运行会更快
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          # 你可以指定项目使用的 Flutter 版本
          flutter-version: '3.22.2' # 已更新以满足项目对 Dart SDK 的要求
          channel: 'stable'
          cache: true

      # 步骤 3: 获取项目依赖
      # 在执行任何 flutter 命令之前，需要先运行 `pub get`
      - name: Install dependencies
        run: flutter pub get

      # 步骤 4: 运行代码分析
      # 我们将错误输出重定向到一个日志文件，并设置 continue-on-error 为 true。
      # 这可以确保即使分析失败，我们也能继续执行下一步来发表包含详细错误信息的评论。
      - name: Run static analysis
        id: analyze
        run: flutter analyze > flutter_analyze.log 2>&1
        continue-on-error: true

      # 步骤 5: 如果分析失败，则在 PR 中添加评论
      # 仅当上一步（id: analyze）失败时运行
      - name: Comment on PR on failure
        if: steps.analyze.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          # 使用您在仓库 Secrets 中设置的个人访问令牌
          # 这将使得评论以您的身份发布
          github-token: ${{ secrets.PR_COMMENTER_TOKEN }}
          script: |
            const fs = require('fs');

            // 仅在 pull request 事件中运行
            if (context.eventName === 'pull_request') {
              const prNumber = context.issue.number;
              const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

              // 读取分析步骤产生的日志文件
              let errorOutput = '无法读取错误日志。';
              try {
                errorOutput = fs.readFileSync('flutter_analyze.log', 'utf8');
              } catch (e) {
                console.error('Error reading log file:', e);
              }

              const body = `
              ❌ **Flutter Analyzer 失败**

              静态代码分析检查发现问题。

              *   **[查看完整的CI日志](${runUrl})**

              <details>
              <summary>点击展开错误详情</summary>

              \`\`\`
              ${errorOutput}
              \`\`\`
              </details>
              `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
            }
